// Jenkinsfile (replace/merge into your existing K8s deploy + annotate stages)
// Assumes you already computed SHORTSHA and have KUBECONFIG_FILE credential.
stage('Deploy to Kubernetes (Rolling Update)') {
  steps {
    withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG_FILE')]) {
      bat '''
        set KUBECONFIG=%KUBECONFIG_FILE%
        kubectl apply -f k8s\\namespace.yaml
        kubectl apply -f k8s\\deployment.yaml
        kubectl apply -f k8s\\service.yaml

        kubectl -n mldevopskatir set image deployment/mldevops mldevops=katiravan/mldevops:git-%SHORTSHA%

        kubectl -n mldevopskatir patch deployment mldevops ^
          -p "{\\"spec\\":{\\"template\\":{\\"metadata\\":{\\"annotations\\":{\\"kubernetes.io/change-cause\\":\\"Jenkins build %BUILD_NUMBER% image katiravan/mldevops:git-%SHORTSHA% commit %SHORTSHA%\\"}}}}}}"
      '''
    }
  }
}

stage('Rollout Gate (Must Succeed)') {
  steps {
    withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG_FILE')]) {
      bat '''
        set KUBECONFIG=%KUBECONFIG_FILE%
        kubectl -n mldevopskatir rollout status deployment/mldevops --timeout=180s
        kubectl -n mldevopskatir get deploy mldevops -o wide
        kubectl -n mldevopskatir get pods -o wide
      '''
    }
  }
}

stage('Rollback Evidence (History + Procedure)') {
  steps {
    withCredentials([file(credentialsId: 'kubeconfig', variable: 'KUBECONFIG_FILE')]) {
      bat '''
        set KUBECONFIG=%KUBECONFIG_FILE%
        kubectl -n mldevopskatir rollout history deployment/mldevops
        echo Rollback command:
        echo kubectl -n mldevopskatir rollout undo deployment/mldevops --to-revision=REV
      '''
    }
  }
}
